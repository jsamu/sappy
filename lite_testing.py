import time
import numpy as np
import pandas as pd
import pickle
from collections import defaultdict
import utilities as ut
import satellite_analysis as sappy


#redshifts_01 = [0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1]
#snap_inds_01 = [600, 585, 579, 573, 567, 561, 555, 550, 544, 539, 534]
snap_inds_01 = np.arange(382, 601, 1)[::-1]
redshifts_01 = np.array([4.9880669e-01, 4.9523810e-01, 4.9168649e-01, 4.8815170e-01,
       4.8463359e-01, 4.8113209e-01, 4.7764710e-01, 4.7417840e-01,
       4.7072601e-01, 4.6728969e-01, 4.6386951e-01, 4.6046510e-01,
       4.5707661e-01, 4.5370370e-01, 4.5034641e-01, 4.4700459e-01,
       4.4367820e-01, 4.4036701e-01, 4.3707091e-01, 4.3379000e-01,
       4.3052390e-01, 4.2727271e-01, 4.2403629e-01, 4.2081451e-01,
       4.1760719e-01, 4.1441441e-01, 4.1123599e-01, 4.0807170e-01,
       4.0492171e-01, 4.0178570e-01, 3.9866370e-01, 3.9555559e-01,
       3.9246121e-01, 3.8938051e-01, 3.8631350e-01, 3.8325989e-01,
       3.8021979e-01, 3.7719300e-01, 3.7417939e-01, 3.7117901e-01,
       3.6819169e-01, 3.6521739e-01, 3.6225599e-01, 3.5930741e-01,
       3.5637149e-01, 3.5344830e-01, 3.5053760e-01, 3.4763950e-01,
       3.4475371e-01, 3.4188029e-01, 3.3901921e-01, 3.3617020e-01,
       3.3333331e-01, 3.3050850e-01, 3.2769561e-01, 3.2489449e-01,
       3.2210529e-01, 3.1932771e-01, 3.1656179e-01, 3.1380749e-01,
       3.1106469e-01, 3.0833331e-01, 3.0561331e-01, 3.0290461e-01,
       3.0020699e-01, 2.9752070e-01, 2.9484540e-01, 2.9218110e-01,
       2.8952771e-01, 2.8688520e-01, 2.8425360e-01, 2.8163269e-01,
       2.7902240e-01, 2.7642280e-01, 2.7383369e-01, 2.7125511e-01,
       2.6868689e-01, 2.6612899e-01, 2.6358151e-01, 2.6104420e-01,
       2.5851700e-01, 2.5600001e-01, 2.5349301e-01, 2.5099599e-01,
       2.4850890e-01, 2.4603170e-01, 2.4356440e-01, 2.4110670e-01,
       2.3865880e-01, 2.3622049e-01, 2.3379169e-01, 2.3137251e-01,
       2.2896279e-01, 2.2656250e-01, 2.2417150e-01, 2.2178990e-01,
       2.1941750e-01, 2.1705429e-01, 2.1470021e-01, 2.1235520e-01,
       2.1001931e-01, 2.0769230e-01, 2.0537430e-01, 2.0306510e-01,
       2.0076481e-01, 1.9847330e-01, 1.9619051e-01, 1.9391631e-01,
       1.9165090e-01, 1.8939389e-01, 1.8714561e-01, 1.8490569e-01,
       1.8267420e-01, 1.8045110e-01, 1.7823640e-01, 1.7603000e-01,
       1.7383181e-01, 1.7164180e-01, 1.6946000e-01, 1.6728620e-01,
       1.6512060e-01, 1.6296300e-01, 1.6081330e-01, 1.5867160e-01,
       1.5653780e-01, 1.5441179e-01, 1.5229359e-01, 1.5018320e-01,
       1.4808039e-01, 1.4598539e-01, 1.4389800e-01, 1.4181820e-01,
       1.3974591e-01, 1.3768120e-01, 1.3562390e-01, 1.3357399e-01,
       1.3153151e-01, 1.2949640e-01, 1.2746860e-01, 1.2544800e-01,
       1.2343470e-01, 1.2142860e-01, 1.1942960e-01, 1.1743770e-01,
       1.1545290e-01, 1.1347520e-01, 1.1150440e-01, 1.0954060e-01,
       1.0758380e-01, 1.0563380e-01, 1.0369070e-01, 1.0175440e-01,
       9.9824900e-02, 9.7902100e-02, 9.5986000e-02, 9.4076700e-02,
       9.2173900e-02, 9.0277800e-02, 8.8388200e-02, 8.6505200e-02,
       8.4628700e-02, 8.2758600e-02, 8.0895000e-02, 7.9037800e-02,
       7.7187000e-02, 7.5342500e-02, 7.3504300e-02, 7.1672400e-02,
       6.9846700e-02, 6.8027200e-02, 6.6213900e-02, 6.4406800e-02,
       6.2605800e-02, 6.0810800e-02, 5.9021900e-02, 5.7239100e-02,
       5.5462200e-02, 5.3691300e-02, 5.1926300e-02, 5.0167200e-02,
       4.8414000e-02, 4.6666700e-02, 4.4925100e-02, 4.3189400e-02,
       4.1459400e-02, 3.9735100e-02, 3.8016500e-02, 3.6303600e-02,
       3.4596400e-02, 3.2894700e-02, 3.1198700e-02, 2.9508200e-02,
       2.7823200e-02, 2.6143800e-02, 2.4469800e-02, 2.2801300e-02,
       2.1138200e-02, 1.9480500e-02, 1.7828200e-02, 1.6181200e-02,
       1.4539600e-02, 1.2903200e-02, 1.1272100e-02, 9.6463000e-03,
       8.0257000e-03, 6.4103000e-03, 4.8000000e-03, 3.1949000e-03,
       1.5949000e-03, 1.4352000e-03, 1.2755000e-03, 1.1159000e-03,
       9.5630000e-04, 7.9680000e-04, 6.3730000e-04, 4.7790000e-04,
       3.1860000e-04, 1.5930000e-04, 0.0000000e+00])[::-1]


# Latte data

m12_dirs_peloton = ['/home/jsamuel/scratch/m12i/m12i_res7100',
                    '/home/jsamuel/scratch/m12f/m12f_res7100']

m12_names = ['m12i', 'm12f']

m12_01_data = sappy.satellite_io2.load_hals(sim_directories=m12_dirs_peloton, 
                                            snapshot_index=snap_inds_01, 
                                            sim_names=m12_names, 
                                            host_number=1, 
                                            assign_species=True)

m12_01_param = sappy.halo_reader2.SatelliteCatalog(m12_01_data,
                         host_name_list=m12_names,
                         mask_names=['star.mass'],
                         star_mass_limit=1e5,
                         redshift_list=redshifts_01,
                         snapshot_indices=snap_inds_01)

start = time.time()
x0 = m12_01_param.loop_hal_parallel(m12_01_data, m12_01_param, 'star.mass', 
    sappy.rand_axes.rand_rms_min, **{'host_str':'host.', 'n_iter':1000, 
    'r_frac':None, 'radius_bins':m12_01_param.r_bins, 'return_ax':True, 
    'return_parallel':False})
end = time.time()
print('parallel: ', end - start)
print(x0['m12i'][0])

start = time.time()
x1 = m12_01_param.loop_hal_lite(m12_01_data, m12_01_param, 'star.mass', 
    sappy.rand_axes.rand_rms_min, **{'n_iter':1000, 'r_frac':None, 
    'radius_bins':m12_01_param.r_bins, 'return_ax':True, 'return_parallel':False})
end = time.time()
print('serial: ', end - start)
print(x1['m12i'][0])


start = time.time()
x0 = m12_01_param.loop_hal_parallel(m12_01_data, m12_01_param, 'star.mass', 
    sappy.rand_axes.rand_rms_min, **{'host_str':'host.', 'n_iter':10000, 
    'r_frac':None, 'radius_bins':m12_01_param.r_bins, 'return_ax':True, 
    'return_parallel':False})
end = time.time()
print('parallel: ', end - start)
print(x0['m12i'][0])

start = time.time()
x1 = m12_01_param.loop_hal_lite(m12_01_data, m12_01_param, 'star.mass', 
    sappy.rand_axes.rand_rms_min, **{'n_iter':10000, 'r_frac':None, 
    'radius_bins':m12_01_param.r_bins, 'return_ax':True, 'return_parallel':False})
end = time.time()
print('serial: ', end - start)
print(x1['m12i'][0])
